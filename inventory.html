<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    {% if session.role == 'nv1' %}
      Meu Estoque
    {% else %}
      Estoque T√©cnico - Pe√ßas e Ferramentas
    {% endif %}
  </title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Cabe√ßalho fixo + scroll‚Äësnap -->
  <style>
    .table-head, .table-body {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
    }
    .table-head th {
      background: #f2f2f2;
      color: #2d2d2d;
      font-weight: 600;
      padding: 11px;
      text-align: center;
      border-bottom: 2px solid #dcdcdc;
    }
    #tableContainer {
      max-height: 400px;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      scroll-behavior: smooth;
    }
    #tableContainer tbody tr {
      scroll-snap-align: start;
    }
  </style>
  <script>
    // O objeto stockData √© populado com os dados vindos do back-end
    var stockData = {{ stock|tojson|safe }};
    // Atualizado: se o usu√°rio for T√©cnico, role nv1; caso contr√°rio, nv2 ou nv3
    var sessionRole = "{{ session.role }}";
  </script>
</head>
<body>
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <header class="topbar">
    <div class="topbar-left">
      <img src="{{ url_for('static', filename='coffee_logo.png') }}" alt="Logo" class="topbar-logo">
      <span class="topbar-title">
        {% if session.role == 'nv1' %}
          Meu Estoque - {{ subinventory_nome }}
        {% else %}
          Estoque T√©cnico - Pe√ßas e Ferramentas
        {% endif %}
      </span>
    </div>
    <div class="button-bar">
      {# Apenas usu√°rios que n√£o s√£o nv1 (T√©cnico) podem realizar a√ß√µes como adicionar itens #}
      {% if session.role != 'nv1' %}
        <button class="menu-btn" onclick="openModal('addModal')">üÜï Novo Item</button>
        <button class="menu-btn" onclick="openModal('withdrawModal')">üì§ Retirar Item</button>
        <button class="menu-btn" onclick="openModal('transferModal')">üîÄ Transferir Item</button>
        <button class="menu-btn" onclick="openModal('exportModal')">üìÑ Exportar PDF</button>
      {% endif %}
      <a class="menu-btn" href="{{ url_for('dashboard') }}">üè† Voltar ao Dashboard</a>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PESQUISA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="search-container">
    <form class="search-box" method="get">
      <div class="search-wrapper">
        <input type="text" name="search" placeholder="Pesquisar por nome, c√≥digo, fabricante ou tipo..."
               maxlength="50" value="{{ request.args.get('search', '') }}">
        <label class="checkbox-label">
          <input type="checkbox" name="critico" value="1" onchange="this.form.submit();"
                 {% if request.args.get('critico') == '1' %}checked{% endif %}>
          <span>Itens Cr√≠ticos</span>
        </label>
        <button type="submit">Buscar üîç</button>
      </div>
    </form>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CONTE√öDO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="content">
    {% if session.role == 'nv1' %}
      <h2>Estoque - {{ subinventory_nome }}</h2>
    {% endif %}

    <!-- Cabe√ßalho fixo da tabela -->
    <table class="table-head">
      <thead>
        <tr>
          <th>üÜî C√≥digo</th>
          <th>üìù Nome</th>
          <th>üì¶ Tipo</th>
          <th>üî¢ Quantidade</th>
          <th>üè≠ Fabricante</th>
          <th>‚ö° Voltagem/Amperagem</th>
          <th>üö® N√≠vel Cr√≠tico</th>
          {% if session.role != 'nv1' %}
            <th>‚öôÔ∏è A√ß√µes</th>
          {% endif %}
        </tr>
      </thead>
    </table>

    <!-- Corpo rol√°vel da tabela (ser√° preenchido via JavaScript) -->
    <div id="tableContainer">
      <table class="table-body">
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ MODAIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div id="modalOverlay" class="modal-overlay">
    <!-- Modal: Adicionar Item -->
    <div id="addModal" class="modal" style="margin-top:50px;">
      <h2>Adicionar Item üíæ</h2>
      <form action="{{ url_for('add_inventory') }}" method="post">
        <input type="text" name="nome" placeholder="Nome do item" list="nome_suggestions" required maxlength="50">
        <datalist id="nome_suggestions">
          {% for suggestion in suggestions %}
            <option value="{{ suggestion }}">
          {% endfor %}
        </datalist>
        <select name="tipo" required>
          <option value="">Selecione o tipo</option>
          <option value="Pe√ßas Novas">Pe√ßas Novas</option>
          <option value="Pe√ßas Usadas">Pe√ßas Usadas</option>
          <option value="Ferramentas">Ferramentas</option>
        </select>
        <input type="number" name="quantidade" placeholder="Quantidade" required min="1">
        <input type="text" name="fabricante" placeholder="Fabricante (opcional)"
               list="fabricante_datalist" maxlength="50">
        <datalist id="fabricante_datalist">
          <option value="Evoca"><option value="Rheavendors"><option value="TCN">
          <option value="Philips"><option value="Saeco"><option value="La Marzocco">
          <option value="La Cimbali"><option value="Nuova Simonelli"><option value="Faema">
          <option value="ECM"><option value="Rocket Espresso"><option value="Victoria Arduino">
          <option value="Rancilio"><option value="De'Longhi"><option value="Jura">
          <option value="QAB"><option value="Breville"><option value="Krups">
          <option value="Miele"><option value="Bosch"><option value="Cuisinart">
          <option value="Tchibo"><option value="Gaggia"><option value="Smeg">
          <option value="Bialetti"><option value="La Pavoni"><option value="N&W">
          <option value="Fiorenzato"><option value="Wega"><option value="Mokita">
          <option value="Hamilton Beach">
        </datalist>
        <input type="text" name="voltagem" placeholder="Voltagem / Amperagem (opcional)"
               maxlength="20" list="voltagem_datalist">
        <datalist id="voltagem_datalist">
          <option value="220v"><option value="127v"><option value="24v">
          <option value="12v"><option value="2A"><option value="3A"><option value="10A">
        </datalist>
        <input type="number" name="nivel_critico" placeholder="N√≠vel Cr√≠tico (opcional)" min="0">
        <div class="modal-buttons">
          <button type="submit">Adicionar</button>
          <button type="button" onclick="closeModal('addModal')">Cancelar</button>
        </div>
      </form>
    </div>

    <!-- Modal: Retirar Item -->
    <div id="withdrawModal" class="modal">
      <h2>Retirar Item üì§</h2>
      <form action="{{ url_for('withdraw_inventory') }}" method="post">
        <select name="codigo" required>
          <option value="">Selecione o item</option>
          {% for item in stock %}
            <option value="{{ item.codigo }}">{{ item.codigo }} - {{ item.nome }}</option>
          {% endfor %}
        </select>
        <input type="number" name="quantidade" placeholder="Quantidade" required min="1">
        <div class="modal-buttons">
          <button type="submit">Retirar</button>
          <button type="button" onclick="closeModal('withdrawModal')">Cancelar</button>
        </div>
      </form>
    </div>

    <!-- Modal: Transferir Item -->
    <div id="transferModal" class="modal">
      <h2>Transferir para Subestoque üîÄ</h2>
      <form action="{{ url_for('transfer_inventory') }}" method="post">
        <select name="codigo" required>
          <option value="">Selecione o item</option>
          {% for item in stock %}
            <option value="{{ item.codigo }}">{{ item.codigo }} - {{ item.nome }}</option>
          {% endfor %}
        </select>
        <!-- Atualizado: listando subestoques usando subinventories -->
        <select name="subestoque_id" required>
          <option value="">Selecione o Subestoque</option>
          {% for sub in subinventories %}
            <option value="{{ sub.id }}">{{ sub.nome }}</option>
          {% endfor %}
        </select>
        <input type="number" name="quantidade" placeholder="Quantidade" required min="1">
        <div class="modal-buttons">
          <button type="submit">Transferir</button>
          <button type="button" onclick="closeModal('transferModal')">Cancelar</button>
        </div>
      </form>
    </div>

    <!-- Modal: Exportar PDF -->
    <div id="exportModal" class="modal">
      <h2>Exportar Itens</h2>
      <form id="exportForm" action="{{ url_for('export_pdf') }}" method="post">
        <p>Marque os itens para exportar:</p>
        <!-- Checkbox para marcar todos -->
        <label>
          <input type="checkbox" id="selectAllExport" onchange="toggleSelectAllExport(this)"> Marcar Todos
        </label>
        <div class="export-list" style="max-height:260px; overflow:auto;">
          {% for item in stock %}
            <label>
              <input type="checkbox" name="codigos" value="{{ item.codigo }}">
              {{ item.codigo }} - {{ item.nome }}
            </label><br>
          {% endfor %}
        </div>
        <div class="modal-buttons">
          <button type="submit">Exportar PDF</button>
          <button type="button" onclick="closeModal('exportModal')">Cancelar</button>
        </div>
      </form>
    </div>

    <!-- Modal: Editar Usu√°rio -->
    <div id="editUserModal" class="modal">
      <h2>Editar Usu√°rio</h2>
      <form id="editUserForm" method="post" action="">
        <input type="text" name="username" id="editUsername" placeholder="Login" readonly required>
        <input type="password" name="password" placeholder="Nova Senha (opcional)">
        <select name="role" id="editRole" required onchange="toggleEditStockField()">
          <option value="">Selecione o Cargo</option>
          <option value="nv1">nv1 (T√©cnico)</option>
          <option value="nv2">nv2 (T√©cnico+)</option>
          <option value="nv3">nv3 (Gerente)</option>
        </select>
        <!-- Campos para editar os dados de subestoque (se cargo for nv1 ou nv2) -->
        <div id="editStockField" style="display:none;">
          <input type="text" name="sub_id" id="editSubId" placeholder="ID do Sub-Estoque">
          <input type="text" name="sub_nome" id="editSubNome" placeholder="Nome do Sub-Estoque">
        </div>
        <div class="modal-buttons">
          <button type="submit">Atualizar</button>
          <button type="button" onclick="closeModal('editUserModal')">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <footer class="footer">
    ¬©¬†2025 ‚Ä¢ Desenvolvido por <a href="https://github.com/chivartz" target="_blank">Yuri¬†Schwartz</a>
  </footer>

  <!-- Script para controle de modais e funcionalidades -->
  <script>
    // Abre um modal e exibe o overlay
    function openModal(modalId) {
      document.querySelectorAll('.modal').forEach(function(modal) {
        modal.style.display = 'none';
      });
      document.getElementById('modalOverlay').style.display = 'flex';
      document.getElementById(modalId).style.display = 'block';
    }
    // Fecha um modal e oculta o overlay se nenhum estiver aberto
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      var modals = document.querySelectorAll('.modal');
      var algumAberto = Array.from(modals).some(function(modal) {
        return window.getComputedStyle(modal).display !== 'none';
      });
      if (!algumAberto) {
        document.getElementById('modalOverlay').style.display = 'none';
      }
    }
    window.onclick = function(event) {
      var overlay = document.getElementById('modalOverlay');
      if (event.target == overlay) {
        closeModal('addModal');
        closeModal('withdrawModal');
        closeModal('transferModal');
        closeModal('exportModal');
        closeModal('editUserModal');
      }
    }
    // Fun√ß√£o para selecionar ou desmarcar todas as checkboxes no modal de exporta√ß√£o
    function toggleSelectAllExport(masterCheckbox) {
      var exportContainer = document.querySelector(".export-list");
      var checkboxes = exportContainer.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach(function(checkbox) {
        checkbox.checked = masterCheckbox.checked;
      });
    }
    // Fun√ß√£o para alternar a exibi√ß√£o do campo de subestoque no modal de cria√ß√£o
    function toggleStockField() {
      var chk = document.getElementById("createStockChk").checked;
      if (chk) {
        document.getElementById("stockField").style.display = "block";
      } else {
        document.getElementById("stockField").style.display = "none";
      }
    }
    // Fun√ß√£o para alternar a exibi√ß√£o dos campos de subestoque no modal de edi√ß√£o
    function toggleEditStockField() {
      var role = document.getElementById("editRole").value;
      if (role === "nv1" || role === "nv2") {
        document.getElementById("editStockField").style.display = "block";
      } else {
        document.getElementById("editStockField").style.display = "none";
        document.getElementById("editSubId").value = "";
        document.getElementById("editSubNome").value = "";
      }
    }
    // Fun√ß√£o para abrir o modal de edi√ß√£o de usu√°rio e preencher os campos
    function openEditModal(username, role, sub_id, sub_nome) {
      document.getElementById("editUsername").value = username;
      document.getElementById("editRole").value = role;
      if ((role === "nv1" || role === "nv2") && sub_id) {
        document.getElementById("editStockField").style.display = "block";
        document.getElementById("editSubId").value = sub_id;
        document.getElementById("editSubNome").value = sub_nome;
      } else {
        document.getElementById("editStockField").style.display = "none";
        document.getElementById("editSubId").value = "";
        document.getElementById("editSubNome").value = "";
      }
      document.getElementById("editUserForm").action = "/edit_user/" + username;
      openModal('editUserModal');
    }
    // Exemplo de fun√ß√£o para preencher a tabela com stockData (caso seja necess√°rio)
    function preencherTabela() {
      var tbody = document.getElementById('tableBody');
      tbody.innerHTML = "";
      stockData.forEach(function(item) {
        var tr = document.createElement('tr');
        tr.innerHTML = "<td>" + item.codigo + "</td>" +
                       "<td>" + item.nome + "</td>" +
                       "<td>" + item.tipo + "</td>" +
                       "<td>" + item.quantidade + "</td>" +
                       "<td>" + (item.fabricante || "") + "</td>" +
                       "<td>" + (item.voltagem || "") + "</td>" +
                       "<td>" + (item.nivel_critico != null ? item.nivel_critico : "") + "</td>";
        if (sessionRole !== "nv1") {
          var acaoTd = document.createElement('td');
          acaoTd.innerHTML = '<a href="#" onclick="alert(\'Editar item n√£o implementado\'); return false;">Editar</a> ' +
                             '<a href="#" onclick="alert(\'Excluir item n√£o implementado\'); return false;">Excluir</a>';
          tr.appendChild(acaoTd);
        }
        tbody.appendChild(tr);
      });
    }
    // Chamada para preencher a tabela ao carregar a p√°gina
    preencherTabela();
  </script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
